<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content=""><title>Write an LLVM Backend(零)：简介 | 悲催的袜子</title>
  <meta name="keywords" content="LLVM">
  <meta name="description" content="无"><link rel="stylesheet" href="/assets/main.css?v=0.2.5" />
<script src="/assets/main.js?v=0.2.5" defer></script><link rel="stylesheet" href="/assets/css/tomorrow.css" />
<script src="/assets/js/highlight.js"></script><script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script></head>
<body class="body-post">
    <a href="/" class="logo"><img src="/sock.svg" class="logo_img"><h1>悲催的袜子</h1>
</a><main class="post__wrapper"><nav class="top-nav">

<a href="/" class="nav-link ">主页</a>


<a href="/about/" class="nav-link ">关于</a>


<a href="/archive.html" class="nav-link ">归档</a>


</nav><div class="post__top_navs clearfix">
    <nav class="post__archive_path"><a href="/" id="archiveBtn">
        <div class="post__archive_icon">
          <svg width="40" height="40">
            <circle class="circle-progress" r="18" cy="20" cx="20"  stroke-linejoin="round" stroke-linecap="round" />
          </svg>
          <span class="post__archive_icon"></span>
        </div>
        主页
      </a>
    </nav>
  </div>
  <article class="post">
    <header class="post__header">
      <h1 class="post__title">Write an LLVM Backend(零)：简介</h1>
      <div class="post__meta">
        <time>2020-11-01 18:38</time>
      </div>
    </header>
    <div class="post__content content">
      <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#简介">简介</a>
<ul>
<li class="toc-entry toc-h2"><a href="#目标读者">目标读者</a></li>
<li class="toc-entry toc-h2"><a href="#前置知识">前置知识</a></li>
<li class="toc-entry toc-h2"><a href="#基本步骤">基本步骤</a></li>
<li class="toc-entry toc-h2"><a href="#准备工作">准备工作</a></li>
</ul>
</li>
</ul><h1 id="简介">
<a class="anchor" href="#%E7%AE%80%E4%BB%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>简介</h1>

<p>本文档描述了编写编译器后端的技术，
这些后端将LLVM中间表示（IR）转换为特定机器或其他语言的代码，
这些代码可以是汇编代码也可以是二进制代码（可用于JIT编译器）。</p>

<p>LLVM的后端是一个平台独立的代码生成器，
它可以为不同类型的目标CPU生成代码，
包括X86、PowerPC、ARM和SPARC。
后端还可以为GPU或Cell处理器的SPU生成代码，
以支持计算内核的执行。</p>

<p>本文档主要关注<code class="language-plaintext highlighter-rouge">llvm/lib/Target</code>目录中的现有示例，
特别是为SPARC平台创建静态编译器(也就是发射汇编码)，
因为SPARC具有相当典型的特征，
比如RISC指令集和常见的调用约定。</p>

<h2 id="目标读者">
<a class="anchor" href="#%E7%9B%AE%E6%A0%87%E8%AF%BB%E8%80%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>目标读者</h2>

<p>本文档的受众是需要编写LLVM后端来为特定的硬件或软件平台生成代码的开发者。</p>

<h2 id="前置知识">
<a class="anchor" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" aria-hidden="true"><span class="octicon octicon-link"></span></a>前置知识</h2>

<p>在阅读本文档之前，必须先阅读以下重要文档：</p>

<ul>
  <li>
    <p><a href="https://releases.llvm.org/11.0.0/docs/LangRef.html">LLVM Language Reference Manual</a>–LLVM汇编语言的参考手册。</p>
  </li>
  <li>
    <p><a href="https://releases.llvm.org/11.0.0/docs/CodeGenerator.html">The LLVM Target-Independent Code Generator</a>–
用于将LLVM内部表示转换为指定平台的机器码的组件（类和代码生成算法）的指南。
特别注意代码生成阶段：指令选择、调度和形成、基于SSA的优化、寄存器分配、Prolog/Epilog代码插入、后期机器代码优化和代码发射。</p>
  </li>
  <li>
    <p><a href="https://releases.llvm.org/11.0.0/docs/TableGen/index.html">TableGen</a>–TableGen（tblgen）应用程序的描述文档，
该程序管理LLVM代码生成所需的特定信息。
TableGen能把目标描述文件（后缀.td）转换成用于代码生成的C++代码。</p>
  </li>
</ul>

<h2 id="基本步骤">
<a class="anchor" href="#%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>基本步骤</h2>

<p>编写将LLVM IR转换为指定平台的机器码或其他语言的代码的编译器后端，需要以下步骤：</p>

<ul>
  <li>创建TargetMachine类的子类，
该类描述目标计算机的特征，
这一步可以参考已有后端的TargetMachine类及其头文件；
例如，直接复制SparcTargetMachine.cpp和SparcTargetMachine.h但更改其文件名，
并且更改引用“Sparc”的代码以引用您的代码。</li>
  <li>描述目标平台的寄存器。
使用TableGen从RegisterInfo.td文件生成定义寄存器、寄存器别名和寄存器组的代码。
还可能需要为TargetRegisterInfo的子类编写代码，这些代码代用于支持寄存器的分配以及描述寄存器间的约束。</li>
  <li>描述目标平台的指令集。
使用TableGen从TargetInstrFormats.td和TargetInstrInfo.td文件生成描述目标平台的指令集的代码。
您可能需要手动为TargetInstrInfo的子类编写代码，以描述目标平台支持的某些特殊指令。</li>
  <li>描述指令选择规则，该过程将LLVM IR的有向无环图（DAG）表示转换到目标平台原生指令表示。
使用TableGen根据TargetInstrInfo.td文件从定义的模式来生成支持指令选择的代码，
有时需要手动为XXXISelDAGToDAG.cpp编写代码来完成DAG-to-DAG的转换，
有时还需要手动为XXXISelLowering.cpp文件编写代码来替换不被SelectionDAG原生支持的操作和数据类型。</li>
  <li>编写汇编生成器，汇编生成器将LLVM IR转换为目标计算机的GAS格式。
你需要在TargetInstrInfo.td文件中增加assembly strings。
同时还需要实现AsmPrinter的子类以及TargetAsmInfo的子类，
来实现LLVM IR到汇编的转换。</li>
  <li>（可选）添加对子平台(具有不同功能的变体)的支持。
实现TargetSubtarget的子类，
该类允许您使用<code class="language-plaintext highlighter-rouge">-mcpu=</code>和<code class="language-plaintext highlighter-rouge">-mattr=</code>命令行选项。</li>
  <li>（可选）添加JIT支持并创建机器码发射器(TargetJITInfo的子类)，
它用于直接将二进制代码发送到内存中。</li>
</ul>

<p>在.cpp和.h文件中，首先为这些方法建立占位，然后在以后实现它们。
最初，您可能不知道这些类需要哪些私有成员，哪些类需要子类化。</p>

<h2 id="准备工作">
<a class="anchor" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" aria-hidden="true"><span class="octicon octicon-link"></span></a>准备工作</h2>


    </div>
  </article><aside class="post__contact"><h4><a href="/about/">悲催的袜子</a></h4>
  <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
<div class="icon__list"><a href="mailto:mantis-shrimp@outlook.com" class="icon__link" target="_blank"><svg class="icon__stroke" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
  <polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a></div>
</aside>
</main><script>hljs.initHighlightingOnLoad();</script><footer class="site-footer">
  © 2021<a href="/">悲催的袜子</a>. Theme<a href="https://github.com/erlzhang/jekyll-theme-persephone" target="_blank">Persephone</a>
</footer>

  </body>
</html>
